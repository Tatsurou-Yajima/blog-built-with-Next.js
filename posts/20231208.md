---
title: "【CakePHP2】１つのテーブル内で階層構造を実現する方法"
date: '2023-12-08'
thumbnail: 'https://images-for-yajima-tech-blog.s3.amazonaws.com/cakephp_logo.jpg'
---

# 【CakePHP2】１つのテーブル内で階層構造を実現する方法

![logo](https://images-for-yajima-tech-blog.s3.amazonaws.com/cakephp_logo.jpg)

## はじめに

CakePHP2では、１つのテーブル内で階層構造のデータを扱うことができます。

この記事では、どのように階層構造を実現しているかを記載します。

## 階層構造とは？
階層構造とは、例えば以下のようなデータです。

- 趣味`（1階層目）`
  - アウトドア系`（2階層目）`
    - ソロキャンプ`（3階層目）`
    - テニス`（3階層目）`
  - インドア系`（2階層目）`
    - 音楽鑑賞`（3階層目）`
    - 映画鑑賞`（3階層目）`

一番上の1階層目が「趣味」。

次の2階層目が「アウトドア系」および「インドア系」。

その次の3階層目が「ソロキャンプ」、「テニス」、「音楽鑑賞」、「映画鑑賞」です。

他には掲示板のスレッドなども階層構造になっていることが多いですね。

では、この階層構造はどのような仕組みで実現されているのでしょうか？

## どうやって階層構造にしているか？
では、CakePHPではこの階層構造をどのように表現しているかをみていきます。

階層構造にしたいテーブルに、以下の3つのカラムを作成します。

- 親レコードのID
- 左端の座標
- 右端の座標

CakePHPのドキュメントでは以下のように記載されています。

> 親 - デフォルトのフィールド名は「parent_id」です。親オブジェクトの id を格納するためのものです。
> 
> 左端 - デフォルトのフィールド名は「lft」です。現在のオブジェク> トの 左端の座標を入力します。
> 
> 右端 - デフォルトのフィールド名は「rght」です。現在のオブジェクトの 右端の座標を入力します。

[Tree - 2.x](https://book.cakephp.org/2/ja/core-libraries/behaviors/tree.html#id1)

親、座標という概念については、偉大な先人たちが解説してくださっているのでぜひそちらをご覧ください。

[階層構造 データベース - Google検索](https://www.google.com/search?q=%E9%9A%8E%E5%B1%A4%E6%A7%8B%E9%80%A0+%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9&rlz=1C5CHFA_enJP968JP968&oq=%E9%9A%8E%E5%B1%A4%E6%A7%8B%E9%80%A0+&aqs=chrome.6.69i57j0i512l9.9342j1j7&sourceid=chrome&ie=UTF-8)

ここではひとまず、「**親と座標を定義すれば階層構造を作れる**」と思っていただければ大丈夫です。

## CakePHP2上で階層構造を扱うには？
では、実際に階層構造を実装していきます。

基本的にはドキュメントの通りで、特別難しいことはありません。

CakePHP2では、「**Treeビヘイビア**」を使用することで階層構造を扱えるようにします。

以下のような手順です。

1. `parent_id`, `lft`, `rght`カラムを含んだテーブルを作成。
1. 1のテーブルにデータを挿入。（※あとで補足）
1. モデル内に「`$actAs`」変数を宣言

これで以上です。

3. のサンプルコードは以下の通りです。

```php:CategoryModel
class Category extends AppModel {
    public $actsAs = array('Tree');
}
```

### ※ 2.のデータについて補足
`parent_id`さえきちんと設定すれば、`lft`, `rght`は任意の値で問題ありません。

親IDが同一の場合は、テーブルの主キー（Primary Key）順に並べられます。

つまり、座標は気にせずに親IDだけ指定すれば良い、ということです。

ここがCakePHPの便利なポイントです。

通常は座標を１レコードずつ指定しないと想定通りの階層になりません。

## lft, rgjtをどう調整するか？
CakePHP2上では、面倒なlft, rghtの調整は必要ありません。

ではどう調整するか？

下記の一行を記載するだけです。

```php
$this->Category->recover();
```

はい。たったこれだけです。

処理の中で上記のメソッドを実行するだけで、座標が自動的に振り直されます。

これを初めて知った時は感動しましたね。

## 終わりに
以上、CakePHP2で階層構造を実現する方法でした。

CakePHP2はもう表舞台からは姿を消してしまいましたが、意外とまだ採用している現場も多いですよね。

これからも有益な情報などを得る機会があれば発信していきます。

ここまで読んでいただきありがとうございました！
